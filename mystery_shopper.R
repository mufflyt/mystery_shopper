# Set libPaths.
.libPaths("/Users/tylermuffly/.exploratory/R/3.6")

# Load required packages.
library(janitor)
library(lubridate)
library(hms)
library(tidyr)
library(stringr)
library(readr)
library(forcats)
library(RcppRoll)
library(dplyr)
library(tibble)
library(bit64)
library(exploratory)

# Custom R function as Data.
zipcodes.func <- function(){
  library(zipcode)
  data(zipcode)
  zipcode
}

# Steps to produce xtract_from_mcdc_missouri
`xtract_from_mcdc_missouri` <- exploratory::read_delim_file("/Users/tylermuffly/Dropbox/workforce/Data/xtract from mcdc missouri.csv" , ",", quote = "\"", skip = 0 , col_names = TRUE , na = c('','NA') , locale=readr::locale(encoding = "UTF-8", decimal_mark = "."), trim_ws = TRUE , progress = FALSE) %>%
  readr::type_convert() %>%
  exploratory::clean_data_frame()

# Steps to produce zipcodes
`zipcodes` <- zipcodes.func() %>%
  readr::type_convert() %>%
  exploratory::clean_data_frame()

# Steps to produce median_household_income_fro_mMichigan_Population_Studies_Center
`median_household_income_fro_mMichigan_Population_Studies_Center` <- exploratory::read_excel_file( "/Users/tylermuffly/Dropbox/workforce/Data/median household income fro mMichigan Population Studies Center.xlsx", sheet = "nation", na = c('','NA'), skip=0, col_names=TRUE, trim_ws=TRUE, col_types="text") %>%
  readr::type_convert() %>%
  exploratory::clean_data_frame() %>%
  mutate(Zip = as.character(Zip))

# Steps to produce geocorr2014_zip_code_urban_v_rural
`geocorr2014_zip_code_urban_v_rural` <- exploratory::read_delim_file("/Users/tylermuffly/Dropbox/workforce/Data/geocorr2014-zip code urban v rural.csv" , ",", quote = "\"", skip = 1 , col_names = TRUE , na = c('','NA') , locale=readr::locale(encoding = "UTF-8", decimal_mark = "."), trim_ws = TRUE , progress = FALSE) %>%
  readr::type_convert() %>%
  exploratory::clean_data_frame() %>%
  select(-`Total population (2010)`, -`zcta5 to cbsatype10 allocation factor`) %>%
  mutate(`State code` = statecode(`State code`, output_type = "name"), `State code_statecode` = statecode(`State code`, output_type = "alpha_code"), `ZIP census tabulation area` = as.character(`ZIP census tabulation area`))

# Steps to produce the output
exploratory::read_excel_file( "/Users/tylermuffly/Dropbox/Mystery caller revised 7.24.19.xlsx", sheet = "Sheet1", na = c('','NA'), skip=0, col_names=TRUE, trim_ws=TRUE, col_types="text") %>%
  readr::type_convert() %>%
  exploratory::clean_data_frame() %>%
  rename(FPMRS_Physician_Name = X__1) %>%
  mutate(`Exclusions, total` = coalesce(`Exclusion, If Not able to contact, reason`, Exclusion, `Exclusion, Notes`, `Accept Medicare__1`), `Exclusions, total` = recode(`Exclusions, total`, `>5min on hold` = "Greater than five minutes on hold", `>5min without a specific appointment date, need doc to review records first` = "Greater than five minutes on hold", Abroad = "Not in the USA", `August schedule Not available yet, could Not give exact date` = "Schedule not available to make appointment", `busy signal` = "Busy signal ", `Busy signal` = "Busy Signal", `Called physician's personal cell (number provided on website), who gave me number to call office for appt` = "Phone number to FPMRS physician's personal cell phone number", `Can't see schedule without registering` = "Registration required", `Cannot give exact date or provider without registering` = "Registration required", `Clinic Number Not in service` = "Phone number disconnected", `Closed for vacation` = "Closed for vacation", `Doc on medical leave` = "Closed as physician is on medical leave", `dr's personal cell, gave clinic number` = "Phone number to FPMRS physician's personal cell phone number", Duplicate = "Duplicate", Fax = "Fax number listed as phone number", `Integrated medica system` = "Integrated medical system", `Integrated medical system` = "Integrated medical system", `Integrated Medical System` = "Integrated medical system", `Mentioned at end of call would have to do new gyn appt first. Appt date is with urogyn` = "Requires referral", `Military only` = "Military patients only", `Navy only` = "Military patients only", `Need referral first` = "Requires referral", `Needs to review records before booking` = "Requires referral", No = "No", `No answer` = "No answer", `No number listed` = "No phone number listed on web site", `No phone number listed` = "No phone number listed on web site", `No phone number provided` = "No phone number listed on web site", `Not accepting new urogyn patients` = "Not accepting new patients", `number Not in service` = "Phone number disconnected", `Number not in service` = "Phone number disconnected", `Number Not in service` = "Phone number disconnected", `office closed` = "Phone number disconnected", `on hold >5min` = "Greater than five minutes on hold", `On hold >5min` = "Greater than five minutes on hold", `Phone menu does Not recognize number pressed as “valid entry”` = "Greater than five minutes on hold", `Provided with academic office number on voicemail at academic office` = "Phone number to administrative academic office", `Put on hold, call dropped` = "Greater than five minutes on hold", `rang without answer or machine for 2min, then call ended from other side` = "Greater than five minutes on hold", `reach automated recording about referral process, need records first` = "Requires referral", `Reached husband’s cell, who passed phone to receptionist` = "Phone number to FPMRS physician's personal cell phone number", `Reached main number for OB/GYN, provided UROGYN number 504-412-1650.` = "Phone number to administrative academic office", `reached officd private line, but able to find information` = "Phone number to administrative academic office", `Required to see NP first` = "Required to see urogyn nurse practicioner before seeing FPMRS physician", `Requried to see NP first` = "Required to see urogyn nurse practicioner before seeing FPMRS physician", `Urogyn not working at this office` = "Not accepting new patients", `Urology only` = "Not accepting new patients", `went to  office VM` = "Greater than five minutes on hold", `went to  office's VM` = "Greater than five minutes on hold")) %>%
  mutate(Exclusion = impute_na(Exclusion, type = "value", val = "Included in Analysis"), `Exclusions, total` = impute_na(`Exclusions, total`, type = "value", val = "Included"), `Exclusions, total` = factor(`Exclusions, total`), `Exclusions, total` = recode(`Exclusions, total`, `Busy signal ` = "Busy Signal", s = "Greater than five minutes on hold", `Busy Signal` = "Busy Signal", `Phone number to FPMRS physician's personal cell phone number` = "Phone number to FPMRS physician's personal cell phone number", `went to VM (cell)` = "Phone number to FPMRS physician's personal cell phone number", `went to VM (doc's cell)` = "Phone number to FPMRS physician's personal cell phone number", `Went to VM (doc's cell)` = "Phone number to FPMRS physician's personal cell phone number", `Went to vm (doc’s cell)` = "Phone number to FPMRS physician's personal cell phone number", `Went to vm (doc’s home)` = "Phone number to FPMRS physician's personal cell phone number", `Went to VM (home)` = "Phone number to FPMRS physician's personal cell phone number", `wrong number listed (cell)` = "Phone number to FPMRS physician's personal cell phone number", `Wrong number listed (cell)` = "Phone number to FPMRS physician's personal cell phone number", `Wrong number listed (doc's cel)` = "Phone number to FPMRS physician's personal cell phone number", `Wrong number listed (doc’s cell)` = "Phone number to FPMRS physician's personal cell phone number", `Wrong number  listed (someone else)` = "Phone number to FPMRS physician's personal cell phone number", `Wrong number listed` = "Phone number to FPMRS physician's personal cell phone number", `Wrong number listed (home)` = "Phone number to FPMRS physician's personal cell phone number", `wrong number listed (someone else)` = "Wrong Telephone Number Listed", `Wrong number listed (State Farm)` = "Wrong Telephone Number Listed", `Wrong number listed, academic office, went to VM` = "Wrong Telephone Number Listed", `Went to academic office vm` = "Answered by Voicemail", `Went to office vm` = "Answered by Voicemail", `Went to office VM` = "Answered by Voicemail", `went to office's VM` = "Answered by Voicemail", `Went to office's VM` = "Answered by Voicemail", `Went to offices VM` = "Answered by Voicemail", `went to vm` = "Answered by Voicemail", `went to VM` = "Answered by Voicemail", `Went to vm` = "Answered by Voicemail", `Went to VM` = "Answered by Voicemail", `Went to VM, Not sure if personal or clinic` = "Answered by Voicemail", `Went to vm (cell)` = "Phone number to FPMRS physician's personal cell phone number", `Went to VM (cell)` = "Phone number to FPMRS physician's personal cell phone number", No = "Not accepting new patients", `Closed as physician is on medical leave` = "Closed", `Closed for vacation` = "Closed", `Integrated medical system` = "Closed medical system/Military", `Military patients only` = "Closed medical system/Military")) %>%
  rename(Exclusion_Critera = `Exclusions, total`) %>%
  filter(Exclusion_Critera != "Duplicate") %>%
  mutate(`Date called` = excel_numeric_to_date(`Date called`), `Appt date` = excel_numeric_to_date(`Appt date`)) %>%
  mutate(`Zip code` = recode(`Zip code`, `03110, 03756` = "03110", `97225, 97239` = "97225")) %>%
  left_join(geocorr2014_zip_code_urban_v_rural, by = c("Zip code" = "ZIP census tabulation area")) %>%
  select(-`State code`, -`State abbreviation`, -`ZCTA name`, -`State code_statecode`) %>%
  left_join(median_household_income_fro_mMichigan_Population_Studies_Center, by = c("Zip code" = "Zip")) %>%
  select(-Mean, -Pop) %>%
  mutate(`Able to contact` = recode(`Able to contact`, `Received call back from cell` = "Yes, able to contact FPMRS office", yes = "Yes, able to contact FPMRS office", Yes = "Yes, able to contact FPMRS office", .missing = "Unable to contact FPMRS office")) %>%
  mutate(`Able to contact` = recode(`Able to contact`, `Received call back from cell` = "Yes, able to contact FPMRS office", yes = "Yes, able to contact FPMRS office", Yes = "Yes, able to contact FPMRS office", .missing = "Not able to contact FPMRS office")) %>%
  mutate(`Able to contact` = recode(`Able to contact`, yes = "Yes", `Received call back from cell` = "Yes", Yes = "Yes"), `Able to contact` = impute_na(`Able to contact`, type = "value", val = "No"), `Insuance asked before appt date` = recode(`Insuance asked before appt date`, No = "No", no = "No", yes = "Yes", Yes = "Yes", Medicare = "Medicare"), `Insuance asked before appt date` = impute_na(`Insuance asked before appt date`, type = "value", val = "No"), `Accept Medicare` = recode(`Accept Medicare`, No = "Not accepting Medicare", `no - Army only` = "No - Army Only", yes = "Yes, accepting Medicare", Yes = "Yes, accepting Medicare", .missing = "Yes"), `Accepting new patients` = recode(`Accepting new patients`, yea = "Yes", yes = "Yes", Yes = "Yes", ys = "Yes", .missing = "Not accepting new patients"), `Hold Time` = recode(`Hold Time`, `0` = "0", `1.5` = "90", `1.5min` = "90", `1.75, 2min` = "120", `10sec` = "10", `15sec` = "15", `1min` = "60", `1min 10sec` = "70", `1min 20sec` = "80", `1min 45 sec` = "105", `2.25min` = "135", `2.5min` = "150", `2.75min` = "165", `2.75min, 30sec` = "165", `20 sec` = "20", `20sec` = "20", `2min` = "120", `3 min` = "180", `30 sec` = "30", `30sec` = "30", `30sec, then 45 sec` = "75", `35sec` = "35", `3min` = "180", `3min 10 sec` = "190", `3min 20sec` = "200", `4` = "240", `4min` = "240", `5` = "300", `5 sec` = "5", `50 sec` = "50", `50sec` = "50", `5min` = "300", `5sec` = "5", O = "0"), `Hold Time` = parse_number(`Hold Time`)/60, `Central number` = recode(`Central number`, `0` = "Call goes directly to FPMRS clinic", no = "Call goes directly to FPMRS clinic", No = "Call goes directly to FPMRS clinic", `no, academic` = "Call goes to OBGYN academic office", `no, academic office` = "Call goes to OBGYN academic office", `No, academic office` = "Call goes to OBGYN academic office", `No, academic office then operator` = "Call goes to OBGYN academic office", `no, but was for academic program` = "Call goes to OBGYN academic office", `no, doc's cell` = "Doctor's Personal Cell Phone", `no, doc's cell, no longer working there` = "Doctor's Personal Cell Phone", `no, doc's personal cell` = "Doctor's Personal Cell Phone", `no, doc's personal cell, then transferred from medicaid to medicare/private line 2128448590` = "Doctor's Personal Cell Phone", `no, docs cell` = "Doctor's Personal Cell Phone", `No, gen obgyn` = "Call answered by General OBGYN clinic", `no, general obgyn` = "Call answered by General OBGYN clinic", `no, physicain's cell` = "Doctor's Personal Cell Phone", `No, reached gen obgyn and was transfered` = "Call answered by General OBGYN clinic", `No, transferred to central scheduling` = "Call goes directly to FPMRS clinic", yes = "Answered by Central Scheduling", Yes = "Answered by Central Scheduling", `yes, academic office provided number` = "Call goes to OBGYN academic office", `academic office, then central number` = "Call goes to OBGYN academic office"), `Length of call (min)` = recode(`Length of call (min)`, `1` = "60", `1.25` = "75", `1.5` = "90", `1.75` = "105", `2` = "120", `2.25` = "135", `2.5` = "150", `2.5min` = "150", `2.75` = "165", `2min` = "120", `3` = "180", `3.25` = "195", `3.5` = "210", `4` = "240", `4.25` = "255", `4.5` = "270", `5` = "300", `5.5` = "330", `6` = "360", `6.5` = "390", `6.75` = "405", `7` = "420", `7.25` = "435", `7.5` = "450", `8` = "480", `8.5` = "510", `9.5` = "570"), `Length of call (min)` = parse_number(`Length of call (min)`)/60, `2nd language` = recode(`2nd language`, no = "No", No = "No", `no but offered interp for appt` = "No, offered interpreter", yes = "Yes", Yes = "Yes")) %>%
  select(-`Number days wait time`) %>%
  mutate(clean_zip_codes = str_pad(`Zip code`, pad="0", side="left", width=5)) %>%
  left_join(zipcodes, by = c("clean_zip_codes" = "zip")) %>%
  mutate(Business_Days_Until_Appt = bizdays(`Date called`, `Appt date`, "MyCalendar")) %>%
  left_join(xtract_from_mcdc_missouri, by = c("Zip code" = "zcta5")) %>%
  select(-County2, -PlaceFP, -PlaceFP2, -CouSubFP, -CouSubFP2, -cd113, -cd113_2, -puma2k, -puma12, -necta, -nectaDiv, -Cnecta, -cbsa, -MetDiv, -csa, -CBSAType, -PctUrban, -pctcnty, -pctcnty2, -cnty2k, -pctcnty2k, -pctcousub, -pctplace, -pctplace2, -ua, -pctua, -pctcd113, -pctpuma2k, -pctpuma12, -pctnecta, -pctnectadiv, -pctcnecta, -pctcbsa, -pctcsa, -pctmetdiv, -pctcbsatype, -Fipco, -FipCo2, -PlaceName, -CBSAName, -MetDivName, -CSAName, -NectaName, -UAName, -Puma12Name, -UAtype, -Pop10ZCTAstate, -ZipTotPop, -Nstates, -psf, -pctState, -PctState2, -State2, -Stab2, -Pop10State2, -AltZIPs, -NaltZIPs, -SumLev, -Stab, -IntPtLat, -IntPtLon, -LandSQMI, -AreaSQMI, -TotPop10, -esriid, -TotPopACS, -MedianAge, -pctUnder18, -pctOver65, -pctWhite1, -pctBlack1, -pctAsian1, -pctHispanicPop, -TotHHs, -MedianHHInc, -FamHHs, -MedianFamInc, -PovUniverse, -pctPoor, -pctGrpQuarters, -pctInCollege, -pctBachelorsormore, -pctForeignBorn, -TotHUs, -OccHUs, -pctRenterOcc, -MedianHValue, -MedianGrossRent, -ACSYears, -Div, -Reg) %>%
  mutate(Clinic = str_to_title(Clinic)) %>%
  mutate(ACOG_Region = state.x, ACOG_Region = recode_factor(ACOG_Region, CO = "District VIII", AL = "District VII", AR = "District VII", AZ = "District VIII", CA = "District IX", FL = "District XII", GA = "District IV", HI = "District VIII", IA = "District VI", ID = "District VIII", IL = "District VI", IN = "District V", KS = "District VII", LA = "District VII", MA = "District I", MD = "District IV", ME = "District I", MI = "District V", MN = "District VI", MO = "District VII", NC = "District IV", NH = "District I", NJ = "District III", NM = "District VIII", NY = "District II", OH = "District V", OR = "District VIII", PA = "District III", RI = "District I", SD = "District IV", TN = "District VII", TX = "District XI", VA = "District IV", WA = "District VIII", WI = "District VI", CT = "District I", DC = "District IV", KY = "District V", MS = "District VII", NE = "District VI", NV = "District VIII", SC = "District IV", WV = "District IV")) %>%
  rename(FPMRS_Physician_on_List = Docs) %>%
  select(-Exclusion, -`Exclusion, If Not able to contact, reason`, -`Exclusion, Notes`) %>%
  reorder_cols(Clinic, FPMRS_Physician_on_List, FPMRS_Physician_Name, `Zip code`, `Date called`, `Appt date`, `If Not able to contact, reason`, `Insuance asked before appt date`, `First available Male or Female (No midlevel, will see fellow)`, `Accept Medicare`, `Speaking to Male or Female`, `Accepting new patients`, `Recommend elsewhere that takes Medicare`, `Number of transfers`, `Hold Time`, `Central number`, `Length of call (min)`, `Group or Single`, `AMC or Not`, `2nd language`, Notes, `Accept Medicare__1`, Exclusion_Critera, clean_zip_codes, city, state.x, latitude, longitude, Business_Days_Until_Appt, state.y, ZIPName, County, ACOG_Region, `Nunber on List`, `Able to contact`) %>%
  mutate(`Accept Medicare` = recode(`Accept Medicare`, `No, but have discounted self pay option` = "Not accepting Medicare", `Not accepting Medicare` = "Not accepting Medicare", Yes = "Yes, accepts Medicare", `Yes, accepting Medicare` = "Yes, accepts Medicare", `Yes, case by case` = "Yes, accepts Medicare"), `First available Male or Female (No midlevel, will see fellow)` = recode(`First available Male or Female (No midlevel, will see fellow)`, Female = "Female provider", `Could Not get exact provider` = "Female provider", `Depends on review of records` = "Female provider", Either = "Female provider", Male = "Male provider", `Male (2 wk for NP, can schedule with doc first)` = "Male provider", `Not specified` = "Male provider", `Not sure` = "Male provider", `See NP first` = "Female provider", unsure = "Female provider", Unsure = "Female provider"), `Insuance asked before appt date` = recode(`Insuance asked before appt date`, Medicare = "Yes", No = "No", Yes = "Yes", `Went to vm (cell)` = "No"), `Number of transfers` = recode(`Number of transfers`, `0` = "0", `1` = "1", `1 (reached academic, transferred to clinical)` = "1", `2` = "2", O = "0"), `Group or Single` = recode(`Group or Single`, Group = "Group", Single = "Single", Yes = "Group"), `2nd language` = recode(`2nd language`, No = "No", `No but offered interp for appt` = "No", Yes = "Yes")) %>%
  mutate_at(vars(Clinic, `Insuance asked before appt date`, `First available Male or Female (No midlevel, will see fellow)`, `Accept Medicare`, `Speaking to Male or Female`, `Number of transfers`, `Group or Single`, `AMC or Not`, `2nd language`, Exclusion_Critera), funs(factor)) %>%
  mutate(`Date called day of the week` = wday(`Date called`, label = TRUE, abbr = FALSE), `Central number` = recode(`Central number`, `Answered by Central Scheduling` = "Central scheduling answered phone call", `Call answered by General OBGYN clinic` = "General OBGYN answered phone call", `Call goes directly to FPMRS clinic` = "Call goes directly to FPMRS office", `Call goes to OBGYN academic office` = "Call goes directly to OBGYN academic office", `No ,doc's cell` = "Central scheduling answered phone call", `No, academic` = "Call goes directly to OBGYN academic office", `No, academic center` = "Call goes directly to OBGYN academic office", `No, academic office, then gen obgyn` = "Call goes directly to OBGYN academic office", `No, but reached Urology, was on hold for 4min, and then was transferred to Urogyn, which went to VM` = "Call goes directly to Urology academic office", `No, but was for academic program` = "Call goes directly to OBGYN academic office", `No, doc's cell` = "Call goes directly to FPMRS office", `No, doc's cell phone. Provided main office number but No longer working there. Provided name but Not number of new clinic (McCloud in Florence NC` = "Call goes directly to FPMRS office", `No, doc's cell, No longer working there` = "Call goes directly to FPMRS office", `No, doc's personal cell` = "Call goes directly to FPMRS office", `No, doc's personal cell, then transferred from medicaid to medicare/private line 2128448590` = "Call goes directly to FPMRS office", `No, doc’s cell` = "Call goes directly to FPMRS office", `No, docs cell` = "Call goes directly to FPMRS office", `No, forwarded to appt scheduling` = "Central scheduling answered phone call", `No, general obgyn` = "Call goes directly to OBGYN academic office", `No, physicain's cell` = "Call goes directly to FPMRS office", `No, physician's cell` = "Call goes directly to FPMRS office", `Yes, academic office provided number` = "Call goes directly to OBGYN academic office"), `Central number` = factor(`Central number`)) %>%
  reorder_cols(Business_Days_Until_Appt, `Length of call (min)`, `Hold Time`, Exclusion_Critera, Clinic, `Date called day of the week`, FPMRS_Physician_Name, `Number of transfers`, `Insuance asked before appt date`, `First available Male or Female (No midlevel, will see fellow)`, `Speaking to Male or Female`, `Central number`, `Group or Single`, `AMC or Not`, `2nd language`, ACOG_Region, `Date called`, `Appt date`, `If Not able to contact, reason`, `Accept Medicare`, `Accepting new patients`, `Recommend elsewhere that takes Medicare`, Notes, `Accept Medicare__1`, clean_zip_codes, city, state.x, latitude, longitude, state.y, ZIPName, County, `Nunber on List`, `Able to contact`, FPMRS_Physician_on_List, `Zip code`) %>%
  filter(`Date called day of the week` %in% c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday")) %>%
  mutate(state.x = factor(state.x), state.x = statecode(state.x, output_type = "name"), Median_category = cut(Median, breaks = c(-Inf, 10000, 25000, 50000, 100000, 150000, Inf), include.lowest = TRUE, dig.lab = 10)) %>%
  arrange(desc(Clinic)) %>%
  filter(Exclusion_Critera == "Included") %>%
  mutate(Business_Days_Until_Appt_category = cut(Business_Days_Until_Appt, breaks = c(-Inf, 7, 14, 21, 28, 35, 42, 49, 56, 63, 70, Inf), include.lowest = TRUE, dig.lab = 10)) %>%
  filter(!is.na(Business_Days_Until_Appt)) %>%
  mutate(`Greater than 2 week wait` = abs(Business_Days_Until_Appt), `Greater than 2 week wait_category` = cut(`Greater than 2 week wait`, breaks = c(-Inf, 0, 20, Inf), include.lowest = TRUE, dig.lab = 10), `Greater than 2 week wait_category` = recode(`Greater than 2 week wait_category`, `[-Inf,0]` = "Less than two week wait", `(0,20]` = "Less than two week wait", `(20, Inf]` = "Greater than a two week wait")) %>%
  select(-`Greater than 2 week wait`)

